AWSTemplateFormatVersion: '2010-09-09'
Description: 'Monthly Cost and Usage Report'
Parameters:
  resourcePrefix:
    Type: String
Resources:
  CostReportBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Sub "${resourcePrefix}-cost-reports"
      AccessControl: PublicRead
  CostReportBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket: !Ref CostReportBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 's3:GetBucketAcl'
              - 's3:GetBucketPolicy'
              - 's3:PutObject'
            Effect: Allow
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CostReportBucket
                - '/*'
            Principal:
              Service: "billingreports.amazonaws.com"
  MonthlyCostReport:
    Type: "AWS::CUR::ReportDefinition"
    Properties:
      ReportName: !Sub "${resourcePrefix}-monthly-costs"
      ReportVersioning: "OVERWRITE_REPORT"
      RefreshClosedReports: true
      TimeUnit: "MONTHLY"
      Compression: "Parquet"
      Format: "Parquet"
      S3Region: !Ref AWS::Region
      S3Prefix: !Ref resourcePrefix
      S3Bucket: !Ref CostReportBucket
